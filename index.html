<html>
<head>
    <meta charset="utf-8">
    <script src="jquery-1.12.3.min.js" type="text/javascript"></script>
    <script src="knockout-3.4.0.js" type="text/javascript"></script>
    <style>
        body { font-family: Arial }
        .num {
            width: 40px;
            margin-right: 4px;
            margin-bottom: 4px;
            text-align: center;
            border: solid 1px #1e97d0;
            height: 40px;
            font-size: 32px;
            padding-top: 3px;
        }
        .mrBig {
            margin-right: 18px;
        }
        .n36 {
            position: relative;
            border: solid 1px #ccc;
            display: inline-block;
            width: 40px;
            font-size: 18px;
            text-align: center;
            padding-bottom: 8px;
            height: 55px;
            line-height: 15px;
            margin-bottom: 30px;
            top: 26px;
            margin-top: -26px;
            color: #666;
        }
        #cont {
            max-width: 850px;
            font-size: 0;
        }
        .selected {
            border: 2px solid #FF9902;
        }
		.avg {
			font-weight: bold;
		}
        .pn { font-size: 28px; margin-top: 15px; }
		.res { border-bottom: 1px solid #ccc; border-left: 1px solid #ccc; margin-top: 15px; }
		.res td { border-top: 1px solid #ccc; border-right: 1px solid #ccc; min-width: 35px; padding-top: 3px; font-size: 27px; }
        .res td input { border: none; border-bottom: dashed 1px #1e97d0; background-color: #fff; margin-bottom: 3px; }
        .res td.data { text-align: center; }
        input { font-size: 25px; padding-top: 1px; cursor: pointer; }

        @media only screen and (max-width : 852px) {
            #cont { max-width: 620px; }
            .num { width: 45px; height: 45px; font-size: 40px; }
            .n36 { width: 45px; height: 60px; top: 25px; }
            .res td { font-size: 40px; }
        }

        @media only screen and (max-width : 632px) {
            #cont { max-width: 380px; }
            .num { width: 50px; height: 50px; font-size: 42px; }
            .n36 { width: 50px; height: 65px; top: 27px; margin-bottom: 34px; margin-right: 5px; }
            .res td { font-size: 42px; }
        }
    </style>
</head>
<body>
<script type="text/html" id="result-tpl" >
    <table cellspacing="0" cellpadding="0" class="res">
        <tbody data-bind='foreach: rows'>
            <tr>
                <td class="data" data-bind="text: occurrenceCount" ></td>
                <td class="data" data-bind="text: combosCount" ></td>
                <td data-bind="foreach: combos" >
                    <input class="combo" type="button" data-bind="value: comboName, attr: {'data-i': comboI, 'data-j': comboJ}"  />
                </td>
            </tr>
    </tbody>
    </table>
    <div class="pn" >
        ПН = <span data-bind="{text: pn}" ></span>%
    </div>
</script>
<h1>Место силы</h1>
<div id="cont">
    <input class="num mr1" id="inp_0" type="text"/>
</div>
<div><input id="calc" value="Рассчитать" type="button"/></div>
<div data-bind="template: { name: 'result-tpl', data: allData }" id="result">

</div>
<script>
    var kubik = [];
    var answer = "";

    function createNewNumEl(el) {
        var newId = el.id.substring(4)-1+2;
        if ($('#inp_'+newId).length > 0) {
            return false;
        }

        $('#cont').append('<input class="num" id="inp_'+newId+'" type="text"/>');
        var newEl = $('#inp_'+newId);
        var numEl = newId+1*1;
        if ((numEl) % 6 == 0) {
            newEl.addClass('mrBig');
        }
        if ((numEl) % 36 == 0) {
            newEl.addClass('mrBBig');
            newEl.wrap('<span class="n36" ></span>');
            newEl.parent().append(numEl);
        }
        newEl.focus();
        newEl.keydown(function(e) {
            numKeyDown(e);
        });

    }

    function numKeyDown(ev) {
        ev = ev || event;
        var sign=ev.keyCode? ev.keyCode : ev.charCode;

        if (9 != sign) {
            ev.preventDefault();
        }

        var el = ev.target || ev.srcElement
        if (46 == sign || 8 == sign) {
            el.value = '';
            return false;
        }

        switch (sign) {
            case 49:
            case 97:
                el.value = 1;
                break;
            case 50:
            case 98:
                el.value = 2;
                break;
            case 51:
            case 99:
                el.value = 3;
                break;
            case 52:
            case 100:
                el.value = 4;
                break;
            case 53:
            case 101:
                el.value = 5;
                break;
            case 54:
            case 102:
                el.value = 6;
                break;
            default:
                return false;
            break;
        }
        if (!((sign > 48 && sign < 55) || (sign > 96 && sign < 103))) {
            return false;
        }
//        el.value = String.fromCharCode(sign);
        createNewNumEl(el);
    }

    $('.num').keydown(function(e) {
        numKeyDown(e);
    });

    $(document).ready(function() {
        $('#inp_0').focus();
    });

    $('#calc').click(function(e) {
        kubik = [];
        var numbers = $('.num');
        numbers.each(function() {
            if ('' != this.value) {
                kubik.push(this.value);
            }
        });

        var kubikLength = kubik.length;
        var avgVal = kubikLength / 36;
        var msg = "Количество бросков кубика: " + kubikLength + "<br />" + "Вы ввели числа: " + kubik + "<br />"
        kubik.push(kubik[0]);

        ComboObj = function(i, j) {
            this.comboI = i;
            this.comboJ = j;
            this.comboName = i+' '+j;
        }

        var groupCombination = new Array();
        var values = new Array();
        for (i = 1; i <= 6; i++) {
            for (j = 1; j <= 6; j++) {
                var value = comboCount(i, j);
                values.push(value);
                var comboGroup = groupCombination[value] ? groupCombination[value] : new Array();
                comboGroup.push(new ComboObj(i, j));
                groupCombination[value] = comboGroup;
            }
        }
        var MaxVal = Math.max.apply(null, values);
        values = $.unique(values);
        values.sort(function(a, b){return b-a});

        var container = $('#result');
        ko.cleanNode(container[0]);
        container.html('');
//        container.append(msg);

		var avgVal = kubik.length / 36;
		combination = groupCombination;
        var rows = new Array();

        ResultRow = function(occurrenceCount, combos) {
            this.occurrenceCount = occurrenceCount;
            if (typeof(combos) == "undefined") {
                combos = new Array();
            }
            this.combosCount = combos.length;
            this.combos = ko.observableArray(combos);
        }

        var sp1 = 0; var sp2 = 0;
        for (var c = MaxVal; c >=0; c--) {
            var len = groupCombination[c] ? groupCombination[c].length : 0;
            if (c > avgVal) {
                sp1 += Math.abs(len *(c-avgVal));
            }
            if (c < avgVal) {
                sp2 += Math.abs(len *(c-avgVal));
            }
            rows.push(new ResultRow(c, groupCombination[c]));
        }
        var sp = (sp1 + sp2) / 2;
        var pn = Math.round(100*sp / (18 * avgVal));
        var viewModel = function MyViewModel() {
            this.allData = {rows: rows, pn: pn};
        }
        ko.applyBindings(viewModel);

        $(document).on('click', '.combo', function(){
            var $this = $(this);
            var i = $this.data('i');
            var j = $this.data('j');
            var iNumid = 0;
            $('.num').each(function() {
                if ('' == this.value) {
                    return;
                }
                var $this = $(this);
                $this.removeClass('selected');
                if (iNumid == 0 && this.value == i) {
                    iNumid = this.id;
                    return;
                }
                if (iNumid != 0 && this.value == j) {
                    $('#'+iNumid).addClass('selected');
                    $this.addClass('selected');
                }
                iNumid = this.value == i ? this.id : 0;
            })
            var firstEl = $('#inp_0')
            if (iNumid != 0 && firstEl.val() == j) {
                $('#'+iNumid).addClass('selected');
                firstEl.addClass('selected');
            }
        })
    });

    function comboCount(a, b){
        var i = 0;
        var sum = 0;
        for (i=0; i<kubik.length; i++) {
            if (kubik[i] == a && kubik[i+1] == b) {
                sum++;
            }
        }
        return sum;
    }


</script>
</body>
</html>

